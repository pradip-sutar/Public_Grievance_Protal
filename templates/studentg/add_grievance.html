{% extends 'studentg/dashboard_base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block page_title %}Add Grievance{% endblock page_title %}
{% block page_heading %}New Grievance{% endblock page_heading %}
{% block page_content %}
<div class="container mt-3 pl-lg-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-12 px-lg-3">

            <div class="card-custom mt-2 mt-lg-1 help-card">
                <div class="row justify-content-between align-items-center">
                    <div class="col">
                        <h5 class="my-3 card-custom-title">Enter your grievance below</h5>
                    </div>
                </div>
                <form method="post" enctype="multipart/form-data" class="form-loads-subcategories"
                    data-sub-categories-url="{% url 'load_subcategories' %}">
                    {% csrf_token %}
                    {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                    {% endfor %}
                    <div class="form-group mb-3  volunteer-field">
                        <div class="row">
                            <div class="col">
                                {{ form.category.label_tag }}
                                {% render_field form.category class="custom-select" id="id_category" %}
                                {% for error in form.category.errors %}
                                <span class="help-block">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="col">
                                {{ form.sub_category.label_tag }}
                                {% render_field form.sub_category class="custom-select" id="id_sub_category" %}
                                {% for error in form.sub_category.errors %}
                                <span class="help-block">{{ error }}</span>
                                {% endfor %}
                            </div>
                            
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <div class="row">
                            <div class="col">
                                <label for="state">State</label>
                                <select id="state" class="form-control" name="state">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="col">
                                <label for="district">District</label>
                                <select id="district" class="form-control" name="district">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <div class="row">
                            <div class="col">
                                <label for="block">Block</label>
                                <select id="block" class="form-control" name="block">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="col">
                                <label for="village">Village</label>
                                <select id="village" class="form-control" name="village">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3 ">
                        {{ form.subject.label_tag }}
                        {% render_field form.subject class="form-control" placeholder="Subject" %}
                        {% for error in form.subject.errors %}
                        <div class="alert alert-danger small mt-2" role="alert">
                            <p> {{ error }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="form-group mb-3 " hidden>
                        <p class="font-weight-bold">Suggestions</p>
                        <p><a href="#">University Fees Problem</a></p>
                        <p><a href="#">Exam Date</a></p>
                    </div>
                    <div class="form-group my-3">
                        {{ form.message.label_tag }}
                        {% render_field form.message class="form-control" placeholder="Description..." %}
                        {% for error in form.message.errors %}
                        <div class="alert alert-danger small mt-2" role="alert">
                            <p> {{ error }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="form-group">
                        {{ form.image.label_tag }}
                        {% render_field form.image class="form-control" %}
                    </div>
                    <div style="text-align: center" class=" mb-3 ">
                        <div class="row">
                            <div class="col">
                                <button type="submit" class="btn btn-dark submit_grievance" name="draft_submit"
                                    style="width: 100%">
                                    Save as Draft
                                </button>
                            </div>
                            <div class="col">
                                <button type="submit" class="btn btn-success submit_grievance" name="true_submit"
                                    style="width: 100%">Submit
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock page_content %}
{% block javascript %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Load the JSON file
        $.getJSON("{% static 'Odisha.json' %}", function(data) {
            // Populate state dropdown
            $('#state').append('<option value="">Select State</option>');
            $('#state').append('<option value="Odisha">Odisha</option>'); // You can add more states if needed
            
            // Populate district dropdown based on state selection
            $('#state').change(function() {
                var selectedState = $(this).val();
                $('#district').empty();
                $('#block').empty();
                $('#village').empty();
                if (selectedState === "Odisha") {
                    $('#district').append('<option value="">Select District</option>');
                    $.each(data.districts, function(index, district) {
                        $('#district').append('<option value="' + district.district + '">' + district.district + '</option>');
                    });
                }
            });
            
            // Populate block dropdown based on district selection
            $('#district').change(function() {
                var selectedDistrict = $(this).val();
                $('#block').empty();
                $('#village').empty();
                $.each(data.districts, function(index, district) {
                    if (district.district === selectedDistrict) {
                        $('#block').append('<option value="">Select block</option>');
                        $.each(district.subDistricts, function(index, subDistrict) {
                            $('#block').append('<option value="' + subDistrict.subDistrict + '">' + subDistrict.subDistrict + '</option>');
                        });
                    }
                });
            });
            
            // Populate village dropdown based on block selection
            $('#block').change(function() {
                var selectedSubDistrict = $(this).val();
                $('#village').empty();
                $.each(data.districts, function(index, district) {
                    $.each(district.subDistricts, function(index, subDistrict) {
                        if (subDistrict.subDistrict === selectedSubDistrict) {
                            $('#village').append('<option value="">Select Village</option>');
                            $.each(subDistrict.villages, function(index, village) {
                                $('#village').append('<option value="' + village + '">' + village + '</option>');
                            });
                        }
                    });
                });
            });
        });
            let $id_sub_category = $("#id_sub_category");
            let $submit_grievance = $(".submit_grievance");
            let $id_category = $("#id_category");
        
            function get_subcategories() {
                let url = $(".form-loads-subcategories").data("sub-categories-url");
                let category = $id_category.val();
                $.ajax({
                    url: url,
                    data: {
                        'category': category
                    },
                    success: function (data) {
                        console.log(data); // Log data to verify the format
                        if (data.subcategories) {
                            $id_sub_category.html(''); // Clear previous options
                            $.each(data.subcategories, function(index, item) {
                                console.log("Subcategories", item); // Debugging output
                                $id_sub_category.append($('<option>', {
                                    value: item.id,
                                    text: item.name
                                }));
                            });
                            $id_sub_category.removeAttr("disabled");
                            $submit_grievance.removeAttr("disabled");
                        } else {
                            $id_sub_category.html('<option>No sub-categories available</option>');
                            $id_sub_category.attr("disabled", true);
                            $submit_grievance.attr("disabled", true);
                        }
                    },
                    error: function () {
                        $id_sub_category.html('<option>Error loading sub-categories</option>');
                        $id_sub_category.attr("disabled", true);
                        $submit_grievance.attr("disabled", true);
                    }
                });
            }
        
            $id_category.change(function () {
                get_subcategories();
            });
        });
        
</script>
{% comment %} <script src="{% static 'studentg/js/load_subcat.js' %}"></script> {% endcomment %}

{% endblock javascript %}

